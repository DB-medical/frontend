# 프론트엔드 연동 가이드

본 문서는 메디컬 시스템 백엔드(`medical`)와 연동하는 프론트엔드 개발자를 위한 실무 가이드입니다. 인증 방식, 권한 정책, 주요 API, 응답 스키마 요약, 예외 처리 규칙을 포함하므로 초기 개발 환경 구성 시 참고해 주세요.

## 1. 공통 규칙

- **Base URL**: `http://localhost:8080`
- **Content-Type**: 모든 요청/응답은 `application/json`
- **인증 헤더**: `Authorization: Bearer <JWT>`
- **시간/날짜**: ISO-8601 (`yyyy-MM-dd`)
- **권한**: `DOCTOR`, `PHARMACIST` 두 가지 역할. 스프링 시큐리티에서 `ROLE_<ROLE>` 형태로 관리하며, JWT `role` 값과 일치해야 함.

## 2. 인증 플로우

1. **회원 가입** `POST /signup`
   - 공통 필드: `email`, `name`, `password`, `passwordConfirm`, `role`
   - 의사: `doctorProfile.hospitalId`, `doctorProfile.departmentId`
   - 약사: `pharmacistProfile.pharmacyId`
2. **로그인** `POST /login`
   - body: `{ "email": "...", "password": "...", "role": "DOCTOR" }`
   - 성공 시 `{ "accessToken": "...", "role": "DOCTOR" }` 반환
3. **JWT 사용**
   - 발급된 토큰을 이후 모든 보호된 API의 `Authorization` 헤더에 첨부
   - 토큰 만료 시 401 응답. 프론트에서 재로그인 유도 필요

## 3. 권한 매트릭스

| 엔드포인트                          | DOCTOR | PHARMACIST | 비고                                   |
| ----------------------------------- |:------:|:----------:| -------------------------------------- |
| `/medical-records/**`               |   ✅    |     ❌      | 진료 기록 작성/조회 전용              |
| `/pharmacies/**`                    |   ✅    |     ❌      | 처방 전송용 약국 검색                 |
| `/prescriptions` GET                |   ✅    |     ✅      | 의사: 본인 작성분 / 약사: 본인 약국   |
| `/prescriptions/{id}` GET           |   ✅    |     ✅      | 접근 권한 내에서만 가능               |
| `/prescriptions/{id}/dispatch` POST |   ✅    |     ❌      | 의사가 지정 약국으로 전송             |
| `/prescriptions/{id}/status` PATCH  |   ❌    |     ✅      | 약사가 조제 상태 변경                 |

## 4. API 세부 가이드

### 4.1 진료 기록 (`/medical-records`)

- **생성 `POST /medical-records`**
  - 입력: 방문일, 진단, 환자 정보(신규/기존), 증상 목록, 치료 목록, 선택적 `prescription`
  - 처방약 입력 시 `medicineId`로 기존 약 참조하거나 이름/제조사/효능으로 신규 등록 가능
  - 응답: `MedicalRecordDetailResponse`
    - `prescription` 필드에는 약국/약 정보 및 성분 배열 포함
- **조회**
  - `GET /medical-records` 전체 목록(최근 방문 순)
  - `GET /medical-records/{recordId}` 상세
  - `GET /medical-records/patient/{patientId}` 특정 환자
  - `GET /medical-records/patients/{ssn}` 주민번호 기반 환자 기본정보 조회(입력 화면 자동 채움용)

### 4.2 약국 검색 (`/pharmacies`)

- `GET /pharmacies?keyword=<검색어>&size=10`
- 이름/주소에 키워드가 포함된 약국 리스트 반환
- 응답: `[{ "id": 3, "name": "...", "address": "...", "phone": "..." }]`
- 프론트에서 검색 결과 중 선택하여 처방 전송 API에 `pharmacyId` 사용

### 4.3 처방전 (`/prescriptions`)

#### 4.3.1 목록 조회 `GET /prescriptions`

- DOCTOR: 본인이 작성한 처방전 목록 (진단, 환자/의사 요약 포함)
- PHARMACIST: 본인 약국으로 전송된 처방전 목록 (처방 날짜 정렬)

응답 예시:
```json
{
  "prescriptionId": 5,
  "medicalRecordId": 12,
  "issueDate": "2024-08-01",
  "status": "RECEIVED",
  "diagnosis": "상기도 감염 의심",
  "patient": { "id": 7, "name": "김하늘" },
  "doctor": { "id": 3, "name": "테스트의사" }
}
```

#### 4.3.2 상세 조회 `GET /prescriptions/{id}`

- 공통적으로 처방약 목록(성분까지)과 약국/환자/의사 정보를 포함
- 권한에 따라 타 의사/타 약국 접근 시 400 오류

#### 4.3.3 약국 전송 `POST /prescriptions/{id}/dispatch` (의사 전용)

Request:
```json
{ "pharmacyId": 3 }
```
- 성공 시 상태가 `RECEIVED`로 설정되며 약사 목록에 노출
- 이미 다른 의사가 작성한 처방전이면 400 응답

#### 4.3.4 조제 상태 갱신 `PATCH /prescriptions/{id}/status` (약사 전용)

Request:
```json
{ "status": "DISPENSING" }
```
- 허용 상태 전환: `RECEIVED → DISPENSING → COMPLETED`
- 역순 또는 동일 단계 재요청 시 400 에러 메시지 제공
- 타 약국 처방에 대해 호출 시 400 오류 (`"해당 약국으로 전송된 처방전이 아닙니다."`)

## 5. 에러 처리 정책

- 검증 실패: `400 Bad Request` + 문자열 메시지
- 인증 실패: `401 Unauthorized`
- 권한 부족: `403 Forbidden`
- 미존재 자원: `404 Not Found`
- 서버 오류: `500 Internal Server Error`

프론트에서는 `response.body`에 담긴 메시지를 사용자 피드백으로 활용하거나 번역 메시지 매핑을 구성해 주세요.

## 6. 상태/코드 정의

- `PrescriptionStatus`: `RECEIVED`(접수), `DISPENSING`(조제 중), `COMPLETED`(조제 완료)
- `MemberRole`: `DOCTOR`, `PHARMACIST`

## 7. 개발 팁

- Swagger UI: `http://localhost:8080/swagger-ui/index.html`
- DevTools 활성화: `./gradlew bootRun` 실행 후 Hot Reload 지원
- 테스트 실행: `./gradlew test` (H2 메모리 DB, 샘플 데이터 없음)
- 데이터 시드: `src/main/resources/data.sql` 확인 가능(로컬 dev 환경에서만 사용)

## 8. 연동 시나리오 요약

1. **의사 로그인 → 환자 검색 → 진료 기록 작성** (처방 포함 가능)
2. **약국 검색 → 처방 전송** (`POST /prescriptions/{id}/dispatch`)
3. **약사 로그인 → 처방 목록/상세 확인 → 상태 변경** (`PATCH /prescriptions/{id}/status`)
4. **완료 상태 도달 시 추가 변경 차단** (UI에서 버튼 비활성화 권장)

필요 시 추가 API 또는 DTO 설명이 있으면 백엔드 팀에 문의해 주세요. PR 제출 전엔 반드시 README의 빌드/테스트 명령을 따라 사전 검증을 마쳐야 합니다.
